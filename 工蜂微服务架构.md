## 微服务架构
工蜂微服务化的原因很直接的就是：不稳定。之前工蜂的所有功能基本全集中在两个服务里：Web、Manager，页面操作、客户端操作（HTTP、SSH）、API调用，蜂拥上来，导致系统出了好几次大的故障。主要是以下几个场景最明显：

Manager即作为代理，又作为管理服务，还承担Web的RPC调用，出问题概率很高
Git客户端请求HTTP协议、SSH协议全在一个服务里，HTTP部分代码有问题，也影响SSH
排查问题困难，一个服务内请求量大，互相影响，难以找到真正源头是哪个类、哪个方法出的问题
Web服务里有大堆连DB的逻辑，还有API调用，还有Webhook触发，经常因为某几个页面操作导致全盘崩溃
工蜂微服务化是基于Spring Cloud构架来实现的，一边并行功能开发一边微服务改造，持续了近1年时间。到目前为止，整体微服务架构如下


系统首先引入了微服务注册中心与配置中心，可以让服务间可以做到自动发现与调用，统一配置管理。在其基础上，再按大的职能，将工蜂分为网关服务、对外服务、基础服务、附加服务、Git仓库服务5个大的类别。
用户请求从网关Nginx进入，经由Uri规则匹配分发，可以根据路径分别将用户请求转到直接对外微服务上。对外服务，又可以分为浏览器请求与Git客户端请求两个小类，不同微服务处理不同的业务逻辑，
并根据本身的需要调用相关的基础数据微服务，完成业务返回或将Git客户端请求转发到Git仓库微服务。基础数据服务为工蜂对外服务提供了必须的后台数据、仓库分片路由、认证等，是系统不可或缺的一部分。
而Git仓库服务，是工蜂最核心的代码仓库托管模块，它是集群化、有主备、可平滑迁移的，可以随时根据用户需要水平扩展。最后是附加微服务，这里有数十个可选择部署的微服务块。微服务化后的系统架构，
有着以下优势：所有应用是按职能拆分的，模块间是解耦的，可以做到持续升级；微服务的架构非常适合容器化部署，充分利用物理机的性能；所有的微服务块都能方便地水平扩展，做到弹性伸缩、高可用；
应用的微服务模块间引入了熔断机制，在调用链达到预设值后可以拒绝高频请求，柔性可用。

因为微服务注册机制是规范化的Rest接口，工蜂的微服务架构可以兼容非Java技术栈，如这里的Nginx+Lua微服务模块；另外，微服务化时，还去除了内网专用的ActiveMq、Zookeeper、MFS依赖，
使其依赖组件更为通用精简；最后，由于微服务化基础，使应用功能的可插拔成为可能。
